<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>ESG综合分析演示（可输入数据）</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; margin: 24px; background:#f7fbff; }
    h1 { margin-bottom: 8px; }
    .controls { display:flex; gap:12px; flex-wrap:wrap; margin-bottom:12px; }
    .card { background:white; padding:14px; border-radius:10px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    label { display:block; font-size:13px; margin-top:8px; }
    input[type="number"] { padding:6px 8px; width:140px; border-radius:6px; border:1px solid #ddd; }
    button { padding:8px 14px; border-radius:8px; border:none; background:#0f62fe; color:white; cursor:pointer; }
    .section { margin-top:18px; max-width:900px; }
    .chart-container { position:relative; height:320px; margin-top:8px; }
    pre { background:#f1f5f9; padding:10px; border-radius:6px; overflow:auto; }
  </style>
</head>
<body>
  <h1>ESG综合分析演示（可输入数据）</h1>

  <div class="card controls">
    <!-- Energy inputs -->
    <div>
      <strong>能源 / 基本参数</strong>
      <label>月均用电 (kWh)
        <input id="input-monthly-energy" type="number" value="1000" />
      </label>
      <label>电价 (元/kWh)
        <input id="input-price" type="number" value="0.8" step="0.01" />
      </label>
      <label>建筑面积 (m²)
        <input id="input-area" type="number" value="200" />
      </label>
      <label>屋顶承重 (kg/m²)
        <input id="input-roof-load" type="number" value="40" />
      </label>
      <div style="margin-top:10px;">
        <button onclick="submitEnergy()">计算能源成本</button>
      </div>
    </div>

    <!-- PV and storage inputs -->
    <div>
      <strong>光伏 / 储能</strong>
      <label>装机容量 (kW)
        <input id="input-pv-capacity" type="number" value="50" step="1" />
      </label>
      <label>年等效满发小时 (h)
        <input id="input-full-hours" type="number" value="1200" />
      </label>
      <label>系统折减系数
        <input id="input-derate" type="number" value="0.78" step="0.01" />
      </label>
      <label>每kW成本 (元)
        <input id="input-capex" type="number" value="5000" />
      </label>
      <label>自耗率 (0-1)
        <input id="input-self-consume" type="number" value="0.4" step="0.01" />
      </label>
      <label>上网电价 (元/kWh)
        <input id="input-feedin" type="number" value="0.3" step="0.01" />
      </label>
      <div style="margin-top:10px;">
        <button onclick="submitPV()">计算PV回报</button>
      </div>
    </div>

    <!-- Carbon inputs -->
    <div>
      <strong>碳</strong>
      <label>年购电量 (kWh)
        <input id="input-annual-grid" type="number" value="12000" />
      </label>
      <label>电网排放因子 (kgCO₂e/kWh)
        <input id="input-grid-factor" type="number" value="0.6" step="0.01" />
      </label>
      <label>PV自用年量 (kWh)
        <input id="input-pv-self" type="number" value="2000" />
      </label>
      <label>碳价 (元/吨)
        <input id="input-carbon-price" type="number" value="50" />
      </label>
      <div style="margin-top:10px;">
        <button onclick="submitCarbon()">计算碳账户</button>
      </div>
    </div>
  </div>

  <!-- Results sections -->
  <div class="section card" id="sec-energy">
    <h3>能源成本与结构分析</h3>
    <pre id="energy-output">未计算</pre>
    <div class="chart-container"><canvas id="chart-energy"></canvas></div>
  </div>

  <div class="section card" id="sec-pv">
    <h3>光伏 + 储能 投资回报</h3>
    <pre id="pv-output">未计算</pre>
    <div class="chart-container"><canvas id="chart-pv"></canvas></div>
  </div>

  <div class="section card" id="sec-carbon">
    <h3>碳排放与碳积分</h3>
    <pre id="carbon-output">未计算</pre>
    <div class="chart-container"><canvas id="chart-carbon"></canvas></div>
  </div>

  <div class="section card" id="sec-esg">
    <h3>ESG 评分与融资建议</h3>
    <pre id="esg-output">未计算</pre>
    <div class="chart-container"><canvas id="chart-esg"></canvas></div>
  </div>

<script>
  const apiBase = "http://127.0.0.1:8000/api";
  const charts = {};

  // Utility to destroy chart if exists
  function safeDestroy(id) {
    if (charts[id]) {
      charts[id].destroy();
      delete charts[id];
    }
  }

  function drawBar(id, labels, values, label) {
    const ctx = document.getElementById(id).getContext("2d");
    safeDestroy(id);
    charts[id] = new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ label, data: values, backgroundColor: 'rgba(15,98,254,0.7)' }] },
      options: { responsive:true, scales: { y: { beginAtZero:true } } }
    });
  }

  // 1) Energy submit
  async function submitEnergy() {
    const monthly_energy_kwh = Number(document.getElementById("input-monthly-energy").value || 0);
    const price_per_kwh = Number(document.getElementById("input-price").value || 0);
    const area_m2 = Number(document.getElementById("input-area").value || 0) || null;
    const roof_load = Number(document.getElementById("input-roof-load").value || 0) || null;

    const payload = { monthly_energy_kwh, price_per_kwh, area_m2, roof_load_kg_per_m2: roof_load };

    const res = await fetch(apiBase + "/energy_cost", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(payload) });
    const data = await res.json();
    document.getElementById("energy-output").textContent = JSON.stringify(data, null, 2);

    // show a small chart: annual energy and cost (one bar each)
    drawBar("chart-energy", ["年度能耗(kWh)","年度费用(元)"], [data.annual_energy_kwh, data.annual_cost_yuan], "能源/费用");
  }

  // 2) PV submit
  async function submitPV() {
    const capacity_kw = Number(document.getElementById("input-pv-capacity").value || 0);
    const derate = Number(document.getElementById("input-derate").value || 0.78);
    const annual_full_load_hours = Number(document.getElementById("input-full-hours").value || 1200);
    const capex_per_kw = Number(document.getElementById("input-capex").value || 5000);
    const self_consumption_ratio = Number(document.getElementById("input-self-consume").value || 0.4);
    const feed_in_tariff = Number(document.getElementById("input-feedin").value || 0.3);

    const payload = {
      capacity_kw, derate, annual_full_load_hours,
      capex_per_kw, opex_per_year: 2000,
      self_consumption_ratio, feed_in_tariff,
      discount_rate: 0.08, lifetime_years: 20
    };

    const res = await fetch(apiBase + "/pv_roi", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(payload) });
    const result = await res.json();
    const pv = result.pv;
    document.getElementById("pv-output").textContent = JSON.stringify(pv, null, 2);

    // show generation & payback
    drawBar("chart-pv", ["年发电(kWh)","年收益(元)","回收期(年)"], [pv.annual_generation_kwh, pv.annual_revenue_yuan, pv.payback_years || 0], "PV 指标");
  }

  // 3) Carbon submit
  async function submitCarbon() {
    const annual_grid_energy_kwh = Number(document.getElementById("input-annual-grid").value || 0);
    const grid_emission_factor = Number(document.getElementById("input-grid-factor").value || 0.6);
    const pv_self_consumed_kwh = Number(document.getElementById("input-pv-self").value || 0);
    const carbon_price_per_tco2 = Number(document.getElementById("input-carbon-price").value || 50);

    const payload = { annual_grid_energy_kwh, grid_emission_factor, pv_self_consumed_kwh, carbon_price_per_tco2 };
    const res = await fetch(apiBase + "/carbon_account", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(payload) });
    const data = await res.json();
    document.getElementById("carbon-output").textContent = JSON.stringify(data, null, 2);

    // show emissions vs offset
    drawBar("chart-carbon", ["年度排放(吨)","PV抵消(吨)","净排放(吨)"], [data.annual_emissions_tco2, data.pv_offset_tco2, data.net_emissions_tco2], "排放/抵消");
  }

  // 4) ESG submit - combine previous results (demo: use energy cost, emissions and payback)
  async function submitESG() {
    // Try to take values from latest results UI; fallback to inputs
    let energyObj = {};
    try { energyObj = JSON.parse(document.getElementById("energy-output").textContent); } catch(e) { energyObj = {} }
    let pvObj = {};
    try { pvObj = JSON.parse(document.getElementById("pv-output").textContent); } catch(e) { pvObj = {} }
    let carbonObj = {};
    try { carbonObj = JSON.parse(document.getElementById("carbon-output").textContent); } catch(e) { carbonObj = {} }

    const energy_cost_yuan = (energyObj.annual_cost_yuan) ? energyObj.annual_cost_yuan : Number(document.getElementById("input-monthly-energy").value || 0) * 12 * Number(document.getElementById("input-price").value || 0);
    const annual_emission_tco2 = carbonObj.annual_emissions_tco2 || (Number(document.getElementById("input-annual-grid").value || 0) * Number(document.getElementById("input-grid-factor").value || 0.6) / 1000);
    const payback_years = pvObj.payback_years || 999;

    const payload = { energy_cost_yuan, annual_emission_tco2, payback_years, optional_indicators: {} };

    const res = await fetch(apiBase + "/esg_score", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(payload) });
    const data = await res.json();
    document.getElementById("esg-output").textContent = JSON.stringify(data, null, 2);

    drawBar("chart-esg", ["E","S","G","Total"], [data.E, data.S, data.G, data.total], "ESG评分");
  }

  // Expose a button for ESG (in case want direct)
  window.submitESG = submitESG;

  // Optional: auto-call once to fill initial charts
  // submitEnergy(); submitPV(); submitCarbon(); submitESG();
</script>

<!-- small footer button to calculate ESG from current inputs -->
<div style="position:fixed; right:20px; bottom:20px;">
  <button onclick="submitESG()">生成 ESG 分数与建议</button>
</div>
</body>
</html>